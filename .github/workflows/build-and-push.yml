name: 'Build & push'

on:
  push:
    tags:
      - 'ofw-*'
      - 'unlshd-*'
      - 'RM*'
  
jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - uses: actions/checkout@v3
      # Generate metadata
      - name: Generate metadata information
        id: metadata
        run: |
          ref_tag=$(echo ${{ github.ref }} | sed -e "s#refs/tags/##")
          echo firmware_version=$(echo $ref_tag | sed -e "s#\(ofw-\)\?##") >> $GITHUB_OUTPUT
          echo image_tag="${{ env.IMAGE_PREFIX }}/f0-firmware:$ref_tag" >> $GITHUB_OUTPUT
          
          # Determine firmware type
          firmware_typere="^([A-Za-z]+)([0-9]+)?-.*"
          if [[ $ref_tag =~ $firmware_typere ]]; then
            firmware_type="${BASH_REMATCH[1]^^}"
          fi

          if [[ -z "$firmware_type" ]]; then
            echo The type of firmware could not be determined. Check the tag!
            exit 1
          fi

          echo firmware_type="$firmware_type" >> $GITHUB_OUTPUT

      # Login into repository package manager
      - name: Login to image repository
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # Build and push docker image
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          context: .
          build-args: ${{ env[format('{0}_REPO_URL', steps.metadata.outputs.firmware_type)] }}
          tags: ${{ steps.metadata.outputs.image_tag }}
